---
typora-root-url: ./..\..\image
---

# 流式布局

## 是什么？

首先，「布局」是指浏览器排列布置 HTML 元素的大小与位置的策略，而流式布局（flow layout）正是所有浏览器的默认的布局策略。流式布局就像微软的 Word 软件，段落从上到下堆叠，文本从左到右排列。

> 注意：为了便于叙述，本文假设了 `writing-mode: horizontal-tb`，此时 block 方向等于垂直方向，inline 方向等于水平方向。

流式布局将所有元素划分成了 3 个种类，每个种类都有特定的布局行为，通过了解它们的布局行为，我们就可以知道流式布局的具体运作机理了。

## 有几种元素？

在流式布局中，元素被分成了 3 种类型，分别是：块级元素（block-level elements）、行内元素（inline elements）、行内块元素（inline-block elements）。

其中，块级元素代表 `display: block`，行内元素代表 `display: inline`，行内块元素代表 `display: inline-block`。我们既可以通过 `display` 属性来查看元素的类型，也可以通过修改 `display` 属性来修改元素的类型。

## 块级元素

块级元素的布局行为是：每个块级元素都会独占一行，哪怕该块级元素的内容的实际的水平尺寸很小，哪怕该块级元素应用了 `inline-size: fit-content`，最后所有块级元素将会一个一个的从上到下依次堆叠。

> `fit-content` 是介于 `min-content` 和 `max-content` 之间的万金油。

## 行内元素

## 行内块元素

## 块级元素

在流式布局中，每个块级元素都会独占一行，哪怕该块级元素的内容的实际水平尺寸很小，哪怕该块级元素使用了 `inline-size: fit-content`。总而言之，所有块级元素将会从上到下的依次堆叠。

> `fit-content` 是介于 `min-content` 和 `max-content` 之间的万金油。

![块级元素总是独占一行](/css/flow-layout/block-element.png)

### 百分比高度陷阱

在流式布局中，块级元素的默认高度（即 `block-size: auto`）的计算策略是「尽可能地收缩以便于刚好容纳下子元素」，就像是真空包装那样。

可见，块级元素的默认高度是根据子元素的尺寸来推算的，这意味着“如果我们给一个 `block-size` 为 `auto` 的块级元素的子元素设置百分比高度，那么该设置就会不生效”。因为在该场景中，父元素和子元素都需要根据彼此的高度来推算出自己的高度，布局引擎显然无法处理这种循环引用，最后唯有忽略掉子元素的百分比高度，这便是「百分比高度陷阱」。

如何解决这个问题？我的方案是为最外层的块级元素指定一个明确的高度值，即：

```css
html, body {
    min-block-size: 100%;
}
```

此时 html 元素的最小高度为视口高度，body 元素的最小高度等于 html 元素的高度。

> 不要使用 `100vh` 来替代 `100%`，因为这会在移动端浏览器发生故障。
>
> 具体来说，Safari 和 Chrome 浏览器会在用户下滑时隐藏掉底栏和顶栏，在用户上滑时显示出底栏和顶栏，由于底栏和顶栏并不属于视口，所以 `1vh` 的大小就会随着用户的上滑和下滑操作而频繁改变，如果某些元素使用了 `vh` 单位，那么该元素就会随着 `vh` 的频繁改变而发生闪烁。Safari 和 Chrome 浏览器为了避免闪烁问题，便决定始终采用隐藏掉底栏和顶栏时的 `vh` 值来作为最终的 `vh` 值。
>
> 这便意味着当底栏和顶栏消失时，`100vh` 会大于实际的视口高度。由于浏览器在首次加载网页后通常都会展示底栏和顶栏，于是如果你采用了 `min-block-size: 100vh`，那么就会导致网页在首次加载时就出现垂直滑动条，哪怕网页内容的实际高度很小。显然，这是 bug。
>
> 另外，`min-block-size: 100dvh` 也是完全正确的方案，它的效果和 `min-block-size: 100%` 是一样的，只不过 IE 完全不支持 `dvh` 单位，详见 [这里](https://caniuse.com/?search=types%3A%20dvh)。

## 行内元素

行内元素总是被包裹在块级元素的内部以充当块级元素的内容，作为内容，行内元素会从左到右依次排列，并在达到容器的水平尺寸极限时自动换行。

![块级元素总是独占一行](/css/flow-layout/inline-element.png)

另外，规范还规定了下述这些 CSS 属性对行内元素是无效的：

- `inline-size`
- `block-size`
- `margin-block`
- `padding-block`
- `float`
- `text-align`

> `margin-inline` 和 `padding-inline` 是可用的。

## 行内块元素

行内块元素会从左到右依次排列，同时也可以使用块级元素的所有属性，它就像是块级元素和行内元素的结合体。

不过需要小心的是，行内块元素和行内元素的换行策略是不同的。当需要换行的时候，整个行内块元素会另起一行，而行内元素则会在该换行的地方换行，我认为行内元素的换行策略才是正确的。

![inline-块级元素的换行机制](/css/flow-layout/inline-block-element.png)

## 可替换元素

> 我认为可替换元素属于行内块元素，因为它的行为表现的和行内块元素一样。

可替换元素的特别之处在于它专门用于展示外部资源，可替换元素本身没有任何内容，外部资源才是它要展示的内容。可替换元素有：

- `<iframe>`
- `<video>`
- `<embed>`
- `<img>`
- `<input type="image">`
- `<option>`（作为 `<select>` 的子元素时）
- `<audio>`（激活了 `controls` 属性时）
- `<canvas>`（设置了 `width` 和 `height` 属性时）
- `<object>`（设置了 `data` 属性时）

> 大多数浏览器都会为 `<canvas>` 设置默认的 `width` 和 `height`，此时 `<canvas>` 默认情况下就是可替换元素了。

### 多余的空白

如果你将可替换元素插入到一个块级元素中去，那么你会发现块级元素的高度稍稍大于可替换元素的高度，块级元素和可替换元素之间会出现一条小小的缝隙，这就是「多余的空白」。这是浏览器的默认行为，如果你想要消除这个空白，那么请这么做：

- 将可替换元素的 `display` 设置为 `block`；
- 将容器元素的 `line-height` 设置为 `0`；

![意料之外的空白](/css/flow-layout/unexpected-space.png)

## 外边距折叠

外边距是有害的东西，使用布局与 padding 来完全替代外边距是一件更加安全的事情，只是这件事情比较难以实施，因为 margin 太常用了...

如果我们要设计一个组件，那么我们不应该给这个组件的外部添加 margin，因为这会损害这个组件的通用性。你想一想，一旦我们给组件的外部增加了 margin，那么我们就必须知道组件的外部环境才能知道组件最后会呈现怎样的效果，这是不好的。

