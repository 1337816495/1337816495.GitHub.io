---
typora-root-url: ..\..
---

# HTTP

## 概述

超文本传输协议（Hypertext Transfer Protocol，简称 HTTP）是一种允许浏览器向服务器获取资源的协议，它的具体做法是：使用 HTTP（应用层协议）来封装请求信息，然后使用 TCP（传输层协议）和 IP（网络层协议）来向目标主机的应用程序（服务器）发送这个请求。

由于 HTTP 请求是在 TCP 的传输阶段中发送的，因此在 HTTP 正式工作之前，浏览器需要通过 TCP 与服务器建立连接，TCP 和 HTTP 的关系如下图所示：

![TCP和HTTP的关系](/static/image/markdown/browser/tcp-http.png)

## CURL

[CURL](https://curl.se/) 是一个使用命令行来获取 URL 资源的工具，本文使用该工具来查看服务器返回的数据。

## HTTP 请求的流程

如果你在浏览器的地址栏中键入了 `https://www.jynxio.com/index.html`，浏览器会做哪些事情呢？本节会讲述浏览器发起 HTTP 请求的具体流程。

### 第一步：构建请求

首先，浏览器会基于 URL 来构建请求行信息，然后准备发起网络请求，请求行的内容如下所示：

```
GET /index.html HTTP1.1
```

### 第二步：查找缓存

浏览器在真正发起网络请求之前，会先查询浏览器缓存中是否存在要请求的文件，若存在则拦截请求、返回缓存资源、结束请求，若不存在或缓存资源已过期，才会进行网络请求。其中，浏览器缓存是一种在本地保存资源副本的技术。

### 第三步：获取地址与端口号

在浏览器向服务器发起 HTTP 请求之前，浏览器首先需要与服务器建立 TCP 连接，这是因为 HTTP 请求是发生在 TCP 连接的数据传输阶段的行为。为了与服务器建立 TCP 连接，浏览器就需要知晓服务器的 IP 地址和端口号。

浏览器通过 DNS 服务来获取 IP 地址，其中 DNS 是指域名系统，它是 Domain Name System 的简写，它是一个将域名与 IP 地址进行一一映射的服务，产生 DNS 的原因是：IP 地址实在是太难记忆了，因为 IP 地址是诸如 `76.76.21.21` 这样的数字标识，人们更喜欢用英文字符来表示地址，但是浏览器又不认识域名，因此就需要一套能将域名映射为 IP 地址的服务。另外，浏览器本身也有 DNS 数据缓存服务，它的作用是缓存解析过的域名，以供下次查询时直接使用，从而减少一次网络请求。

最后浏览器会通过解析 URL 来获取端口号，这个解析行为非常简单，若端口号被明确书写在 URL 中，则直接提取，否则取用默认的端口号，对于 HTTP 而言，默认的端口号是 `80`，对于 HTTPS 而言，默认的端口号是 `443`。

### 第四步：等待 TCP 队列

对于 `http/1.1`，浏览器会为每个域名维护至多 6 个 TCP 连接，此时每个 TCP 同一时刻只能处理一个请求，因此同一域名同一时刻只能接受至多 6 个请求。如果请求的数量超过了 6 个，那么超出的请求就需要排队等待前面的请求处理完成，当前面的请求处理完成后，原来的 TCP 连接不会断开，而是继续用来处理后续的请求。如果请求的数量不超过 6 个，则直接创建新的 TCP 请求来处理。

对于 `http2`，由于 TCP 是可以并行处理多个请求的，因此此时的浏览器只会为每个域名维护一个 TCP 连接。

### 第五步：建立 TCP 连接

见《TCP》。

### 第六步：发送 HTTP 请求

首先，浏览器会向服务器发送请求行，请求行包括了请求方法、请求 URI 和 HTTP 版本协议。发送请求行的目的是告诉服务器浏览器所需的资源。

最常用的请求方法是 GET，如果直接在浏览器的地址栏中键入 `www.jynxio.com`，就是告诉服务器要获取它的首页资源。另一个常用的请求方法是 POST，它用于向服务器发送数据，比如登录一个网站时，就需要通过 POST 方法向服务器发送用户信息，如果使用了 POST 方法，那么浏览器还要准备数据给服务器，这些数据是通过请求体来发送的。

在浏览器发送了请求行后，还需要发送请求头，请求头中包含了关于浏览器的基础信息，比如浏览器所使用的操作系统、浏览器内核、当前请求者的域名、浏览器的 Cookie 等。

### 第七步：重定向

如果你打开 `https://jynxio.com`，你就会发现浏览器最终打开的页面地址是 `https://www.jynxio.com`，之所以会产生这种现象，是因为发生了重定向。在 Terminal 中执行 `curl -I https://jynxio.com` 命令，服务器将返回下述内容：

![永久重定向](/static/image/markdown/browser/permanent-redirect.png)

如果你打开 `https"//www.jynxio.com`，则直接进入到第八步。

### 第八步：返回请求

HTTP 请求送达服务器，待服务器处理结束后，便会返回数据。

1. 首先返回的是响应行，它包括协议版本和状态码。
2. 然后返回的是响应头，响应头包含了服务器自身的一些信息，比如服务器生成返回数据的时间、返回的数据类型（JSON、HTML、流媒体等类型），以及服务器要在客户端保存的 Cookie 等信息。
3. 最后返回的是响应体，它通常包含了 HTML 的实际内容。

在 Terminal 中执行 `curl -i https://www.jynxio.com` 命令，服务器将返回下述内容：

![响应内容的格式](/static/image/markdown/browser/response-content-format.png)

### 第九步：断开连接

通常情况下，一旦服务器向客户端返回了数据，TCP 连接就会断开，不过如果浏览器或者服务器在其头信息中加入了 `Connection:Keep-Alive`，那么 TCP 连接则不会断开，这样浏览器就可以继续通过同一个 TCP 连接来发送请求，保持 TCP 连接的好处是可以省去下次请求时需要建立连接的时间，从而提升资源加载速度。

## 数据缓存

### DNS 缓存

DNS 缓存就是浏览器在本地把域名和对应的 IP 地址关联起来。

### 页面资源缓存

浏览器创建并使用页面缓存的流程如下所示：

![页面缓存](/static/image/markdown/browser/page-cache.png)

当服务器返回 HTTP 响应头给浏览器的时候，浏览器通过响应头中的 `Cache-Control` 字段来设置是否缓存该资源，通过我们还需要为这个资源设置一个缓存保质期，该保质期是通过 `Max-age` 参数来设置的，比如上图中设置的缓存保质期是 2000 秒，相应的 `Cache-Control` 字段内容如下：

```
Cache-Control:Max-age=2000
```

如果浏览器在缓存中找到了要请求的资源，且该缓存资源还未过期，则浏览器会直接使用该缓存资源，并中止网络请求。如果缓存资源过期了，浏览器就会继续发起网络请求，并在 HTTP 请求头中带上：

```
If-None-Match:"4f80f-13c-3a1xb12a"
```

服务器接收到请求后，会根据 `If-None-Match` 的值来判断请求的资源是否有更新。如果没有更新，就返回 304 状态码来告诉浏览器可以继续使用这个资源副本。如果有更新，服务器就直接返回最新的资源给浏览器。

## 如何保持登录状态

1. 用户在登录页面中填入账号与密码，该页面的脚本会根据账号密码来生成用户信息，并调用 POST 方法将用户信息发送给服务器。
2. 服务器接收到用户信息，若用户信息正确，则会生成一段表示用户身份的字符串，并将该字符串写入响应头的 `Set-Cookit` 字段中，然后将响应头发送给浏览器，比如 `Set-Cookie:UID=123456`。
3. 浏览器接收到响应头，若响应头中含有 `Set-Cookie` 字段，则会将该字段的信息缓存至本地。
4. 用户再次访问页面时，浏览器会读取缓存 Cookie 数据，比那个将该数据写入请求头的 Cookie 字段中，然后将该请求头发送给服务器。
5. 服务器接收到请求头，会验证 Cookie 字段的信息，然后根据浏览器的地址与过往的登录记录来判断登录状态，最后决定向浏览器发送何种登录状态的页面数据。
6. 最后，浏览器接收到登陆状态或未登录状态的页面数据。