---
typora-root-url: ..\..
---

# 导航流程

## 概述

> 你需要《Chrome架构》与《渲染流程》来作为前置知识。

从搜索地址栏开始，到呈现出新页面为止的这个过程就称为导航流程。导航流程包含这些阶段，下图是相应的示意图：

- 合成 URL 阶段
- beforeunload 阶段
- 加载数据阶段
- 渲染页面阶段

## 合成 URL 阶段

用户在地址栏中输入了内容并按下回车键后，浏览器会先判断输入的内容是一个 URL（比如 `www.jynxio.com`），还是一个用于搜索的关键词（比如 `jynxio`）。

如果是前者，浏览器就会为这段 URL 补充缺失的协议来合成一段完整的新 URL，比如 `https://www.jynxio.com`。如果是后者，浏览器就会使用相应的搜索引擎来合成一段带有这个搜索关键词的新 URL，比如：

```
https://www.google.com/search?q=jynxio&oq=jynxio&aqs=chrome.0.69i59j35i39j69i60l6.1869j0j9&sourceid=chrome&ie=UTF-8
```

然后，浏览器准备对新 URL 发起网络请求。

## beforeunload 阶段

在浏览器正式发起网络请求之前，浏览器会先触发当前页面的 `beforeunload` 事件，该事件会让网页显示一个确认对话框，来询问用户是否真的要离开该页面，如果用户点击确认，浏览器就会发起网络请求并导航至新页面，否则浏览器就会放弃网络请求，也自然不会导航至新页面了。该事件常用于向用户报告一些有用的信息，比如提示用户当前页面还有未提交的表单等。

如果用户点击了确认或者当前页面没有监听 `beforeunload` 事件，浏览器就会开始发起网络请求，并局部更新浏览器界面，比如标签栏的 favicon 将会变成表示 loading 的图标，不过浏览器不会移除当前页面。

## 加载数据阶段

接下来，浏览器进程会通过 IPC 来将合成好的新 URL 发送给网络进程，然后由网络进程来发起真正的网络请求。

网络进程在发起网络请求之前，会先在本地缓存中查找是否存在所需资源的副本（即缓存数据）。如果找到了，就会直接把资源返回给浏览器进程，然后终止网络请求，否则就会发起网络请求。

如果网络进程发起了网络请求，那么网络进程会先在本地 DNS 缓存中查找是否存在待解析域名的 IP 地址，如果找到了就会直接拿来使用，否则就会使用 DNS 解析来解析域名的 IP 地址，另外如果 URL 使用了 HTTPS，那么还需要建立 TLS 连接（本章不会解释 TLS）。

然后网络进程会根据 IP 地址来找到目标服务器，并与服务器建立 TCP 连接，建立好 TCP 链接之后，网络进程就会构建请求行、请求头等请求信息（与该域名相关的 Cookie 等数据会附加到请求头中），然后通过 HTTP 请求来向服务器发送请求信息。

服务器接收到请求信息后，会根据请求信息来生成响应信息（即响应行、响应头、响应体），并发送给网络进程。

网络进程会在接收到响应行和响应头后就开始解析它们，如果发现状态码是 `301`、`302`，那代表需要重定向，此时网络进程就会从响应头的 `Location` 字段中读取重定向的 URL，然后网络进程就会使用重定向 URL 来重新发起网络请求。

如果响应行的状态码是 `200`，网络进程就会继续往下处理。首先网络进程会通过查看响应头中的 `Content-Type` 字段来分辨响应体的数据是什么类型，再决定应该如何处理响应体的数据。比如，如果 `Content-type` 是 `application/octet-stream`，就代表响应体的数据是字节流类型的，浏览器会按照下载类型来处理这类数据，具体做法是下载管理器就会接管这轮请求，并终止本次导航流程。如果 `Content-type` 是 `text/html`，就代表响应体的数据是 HTML 格式的文本，浏览器就会继续下载数据和准备渲染页面。

## 渲染页面阶段

由于页面渲染是由渲染进程来负责的，因此浏览器进程需要为新页面分配渲染进程，Chrome 浏览器会根据根据同一站点策略来决定如何为页面分配渲染进程。

渲染进程是如何拿到页面数据并执行渲染流水线的呢？具体过程是：

1. 网络进程将响应行和响应头发送给浏览器进程。

2. 浏览器进程接收到响应行和响应头后，就向渲染进程发送 `CommitNavigation` 消息，该消息会携带响应行和响应头。

3. 渲染进程接收到 `CommitNavigation` 消息后，就会和网络进程建立数据传输的管道，建立好数据传输管道后，渲染进程就会向浏览器进程发送 `确认提交` 消息。

4. 浏览器进程接收到 `确认提交` 消息后，浏览器进程就会更新浏览器界面的状态，包括安全状态、地址栏的 URL、前进后退的状态，移除旧页面，如下图所示。同时，渲染进程也会开始接收来自网络进程中的响应体数据。

   ![确认提交](/static/image/markdown/browser/confirm-submission.png)

5. 渲染进程在接收到第一份响应体数据后，就会立马启动渲染流水线，因此数据的传输与处理是一起发生的。

6. 当渲染进程生成完了页面的图层位图后，就会向浏览器进程发送 `DrawQuad` 消息与位图。

7. 浏览器进程接收到 `DrawQuad` 消息后，就会将图层位图合并为页面位图，然后渲染新的页面，并将标签页的 loading 图标替换为新页面的 favicon。

8. 在浏览器进程接收到 `确认提交` 消息来移除旧页面之后，到浏览器进程接收到 `DrawQuad` 消息来渲染新页面之前的这段时间里，页面会是纯白色的。

> 更多细节，请参考 [这 4 篇文章](https://developer.chrome.com/blog/inside-browser-part1/)。
