---
typora-root-url: ..\..
---

# TCP协议

## IP

数据包要在互联网上进行传输，就需要符合网际协议（Internet Protocol，简称 IP）标准，IP 的作用就是将数据包传送至目标主机。互联网上的每台主机都拥有唯一的 IP 地址，这是一个数字地址。

访问网站实际上是一台主机向另一台主机请求信息，比如，如果主机 A 要把数据包发送给主机 B，那么在发送之前，就要为数据包附加上主机 B 的 IP 地址，这样数据包才知道应当发往何处。另外，数据包还会附加上主机 A 的 IP 地址，这样主机 B 才能回复信息给主机 A。这两种附加信息都会被装进一个名为 IP 头的数据结构里，IP 头就是 IP 数据包开头的信息，它不仅包含 `源 IP 地址` 和 `目标 IP 地址`，它还包含 `IP 版本` 和 `生存时间` 等信息。

主机 A 将单个数据包发送给主机 B 的具体流程是：

1. 主机 A 的上层将原始数据包交给网络层。
2. 网络层为原始数据包添加 IP 头，组成了新的 IP 数据包，然后交给底层。
3. 底层通过物理设备将 IP 数据包传输给主机 B的网络层。
4. 主机 B 的网络层拆除 IP 数据包的 IP 头，获得原始数据包，最后将原始数据包交给上层。

## UDP

IP 只负责将数据包传送至目标主机，但是目标主机并不知道应该将数据包交付给哪个应用程序，因此还缺少一种能和应用程序打交道的协议，用户数据包协议（User Datagram Protocol，简称 UDP）便是其中一种。

任何想要访问网络的应用程序都需要绑定一个唯一的端口号，UDP 正是通过端口号来确定应该将数据包交付给哪个应用程序的，端口号其实就是一个数字，比如 `https://localhost:443` 中的 `443` 就是一个端口号。

和 IP 的行为一样，UDP 也会为数据包封装一个 UDP 头，其内包含了 `源端口号` 和 `目标端口号`。

那么，主机 A 将单个数据包发送给主机 B 的具体流程就更新为：

1. 主机 A 的上层将原始数据包交给网络层。
2. 传输层为原始数据包添加 UDP 头，组成了新的 UDP 数据包，然后交给网络层。
3. 网络层为 UDP 数据包添加 IP 头，组成了新的 IP 数据包，然后交给底层。
4. 底层通过物理设备将 IP 数据包传输给主机 B 的网络层。
5. 主机 B 的网络层拆除 IP 数据包的 IP 头，获得了 UDP 数据包，然后将 UDP 数据包交给传输层。
6. 主机 B 的传输层拆除 UDP 数据包的 UDP 头，获得了原始数据包，然后根据 UDP 头中的端口号来将原始数据包交给上层的应用程序。

UDP 具有校验数据包是否正确的能力，但是对于出错的数据包，UDP 却并不提供重发机制，而是直接丢弃它们，另外 UDP 也不能确定数据包是否成功的到达了目的地，因此 UDP 无法保证数据的可靠性，不过 UDP 的传输速度却非常快，所以 UDP 经常会应用在一些关注速度，但不那么严格要求数据完整性的领域，比如在线视频、互动游戏等。

## TCP

对于浏览器请求或邮件等这类对数据传输可靠性要求高的应用，如果使用 UDP 来传输会存在两个问题：

- 数据包在传输过程中容易丢失（比如由于网络波动、网络阻塞、设备故障、恶意程序拦截等）。
- 大文件会被拆分成很多的小数据包来传输，小数据包们会在不同的时间到达接收端，然而 UDP 并不知道该如何将这些小数据包组装还原成完整的文件。

为了解决这两个问题，我们需要引入 传输控制协议（Transmission Control Protocol，简称 TCP），它是一种面向连接的、可靠的、基于字节流的传输层通信协议。相比 UCP，TCP 具有下述三个特点：

- 提供重发机制，可用于解决数据包丢失的问题。
- 提供数据包排序机制，可以保证把乱序的小数据包们组成还原成完整的文件，这是因为 TCP 头不仅包含源端口号和目标端口号，还有一个用于排序的序号。
- TCP 的传输速度比 UDP 更慢，这是因为“三次握手”和“数据包校验机制”等机制把传输过程中的数据包的数量提高了一倍。

那么，主机 A 将单个数据包发送给主机 B 的具体流程就更新为：

1. 主机 A 的上层将原始数据包交给网络层。
2. 传输层为原始数据包添加 TCP 头，组成了新的 TCP 数据包，然后交给网络层。
3. 网络层为 TCP 数据包添加 IP 头，组成了新的 IP 数据包，然后交给底层。
4. 底层通过物理设备将 IP 数据包传输给主机 B 的网络层。
5. 主机 B 的网络层拆除 IP 数据包的 IP 头，获得了 TCP 数据包，然后将 TCP 数据包交给传输层。
6. 主机 B 的传输层拆除 TCP 数据包的 TCP 头，获得了原始数据包，然后根据 TCP 头中的端口号来将原始数据包交给上层的应用程序。

由上述可知，TCP 传输单个数据包的流程和 UDP 的差不多，但是不同之处在于，主机 B 可以通过 TCP 头中的序号来重新排序数据包，以便将小数据包们组装还原为完整的文件。

传输单个数据包只是 TCP 连接过程中的一小部分，下图展示了完整的 TCP 连接过程，可见一个完整的 TCP 连接包括了建立连接、传输数据、断开连接三个阶段。

![TCP连接的生命周期](/static/image/markdown/browser/tcp-lifecycle.png)

1. 首先是建立连接阶段，该阶段需要通过“三次握手”来建立客户端和服务器之间的连接，“三次握手”是指在建立一个 TCP 连接时，两端总共需要发送 3 个数据包来确认连接的建立，这是 TCP 被称为面向连接的原因。
2. 其次是传输数据阶段，在该阶段中，客户端在接收到每一个数据包后，都需要向服务器发送“确认数据包”，服务器在发送了一个数据包之后，如果没能在规定时间内接受到相应的“确认数据包”，就会判断为数据包丢失，并处罚重发机制。另外，一个大的文件在传输过程中会被拆分成很多的小数据包，客户端会按照 TCP 头中的序号为其排序，从而保证组成完整的文件。
3. 最后是断开连接阶段，该阶段通过“四次挥手”保证双方都能断开连接。

