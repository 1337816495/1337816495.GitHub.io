---
typora-root-url: ..\..
---

# 渲染流程

## 概述

渲染流程是指浏览器解析 HTML、CSS、JavaScript 并渲染出页面的过程，按照时间先后顺序，渲染流程分为 7 个阶段，依次是：

1. 构建 DOM 树
2. 样式计算
3. 布局
4. 分层
5. 绘制
6. 分块
7. 光栅化与合成

## 构建 DOM 树

首先，HTML 解析器会将纯文本的 HTML 转译为 DOM 树，DOM 树是树形结构的数据，它描绘了节点与节点之间的关系，浏览器可以通过修改 DOM 树来操纵元素，这也正是浏览器构建 DOM 树的原因。

你可以通过在开发者工具的 `Console` 栏中输入 `document` 来查看当前页面的 DOM 树，或者下图直接演示了如何将 HTML 转译为 DOM 树。

![HTML转译为DOM树](/static/image/markdown/browser/html-to-dom-tree.png)

## 样式计算

样式计算的目的是计算出 DOM 树中的每个元素的具体样式。样式计算又分为 3 个步骤，分别是：

1. 构建 styleSheets
2. 属性值标准化
3. 计算元素的样式

### 第一步 - 构建 styleSheets

页面的 CSS 资源有 3 种来源，分别是：

- `link` 标签引入的外部 CSS 文件。
- `style` 标签包围的 CSS 代码。
- 元素的 `style` 属性内嵌的 CSS 代码。

无论是何种来源的 CSS，渲染引擎（是 Blink 吗？）都会将它们转译为 styleSheets，styleSheets 记录了所有元素的样式，浏览器可以通过修改 styleSheets 来操纵元素的样式，这也正是浏览器构建 styleSheets 的原因。

你可以通过在开发者工具的 `Console` 栏中输入 `document.styleSheets` 来查看当前页面的 styleSheets，如下图所示：

![styleSheets](/static/image/markdown/browser/stylesheets.png)

### 第二步 - 属性值标准化

将 styleSheets 中的属性值由指定值转换为计算值，如下图所示：

![标准化CSS的属性值](/static/image/markdown/browser/normalize-css-property.png)

> 关于计算值：
>
> CSS 样式表中的值需要经过 TODOTODOTODO

样式属性的值只有在被转换为绝对的值后

样式属性的值需要经过一系列的计算和转化，才能被应用至页面上，这个过程依次是指定值 -> 计算值 -> 应用值 -> 实际值，这一系列的转换是为了将相对的值转换为绝对的值，并且有时候还需要根据用户代理的限制，对绝对值进行额外的处理，比如某些设备要求像素数必须为整数时，小数的绝对值就需要取整。

整个转换流程的目的是将相对的值转换为绝对的值（且满足用户代理的限制条件，比如由于硬件限制，像素值必须取整等），这是为了用户代理可以直接应用

指定值是一个样式最初始时的值，它既可能是由开发者、用户代理或实际用户直接给定的，也可能继承自父元素的值，也可能使用该属性的默认值。指定值既可能是一个绝对的数值，比如 `1px`，也可能是一个相对的数值 `1em`。

计算值是由指定值计算而来的，它旨在于尽可能的将不确定的值转换为确定的值，比如将 `em` 转换为 `px`。不过不是所有的指定值都能转换为计算值的，假设某个元素的 `width` 属性采用了百分数值，且该元素的父元素的 `width` 属性的值又暂不确定，那么此时渲染引擎就无法将该指定值转换为计算值，那么该元素的 `width` 属性的计算值就会沿用指定值。

