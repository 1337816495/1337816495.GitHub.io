---
typora-root-url: ..\..
---

# Chrome 架构

## 进程和线程

进程是程序的运行环境（或运行时）。比如运行一个程序时，操作系统会为该程序分配一块内存，用来存放代码、数据和一个执行任务的主线程，这个运行环境就叫做进程。

线程则是任务的执行者，它存在于进程的内部，一个进程可以拥有一至多个线程，启用多线程来并行处理任务可以提升执行的效率。

下图展示了进程的结构。

![进程的结构](/static/image/markdown/browser/process-structure.png)

进程和线程拥有 4 个特性，分别是：

- 进程内的所有线程都可以读写公共数据。
- 进程内的任意一个线程发生了错误，都会导致整个进程发生崩溃。
- 当进程关闭后，操作系统就会回收该进程所占用的所有内存，哪怕线程发生了内存泄漏。
- 进程之间相互隔离，如果进程之间需要进行数据通信，则需要使用进程间通信机制（IPC）。

## 单进程浏览器

在 2007 年之前，市面上的浏览器都是单进程架构的，这意味着浏览器的所有功能模块都运行在同一个进程里，这些模块包括了网络、插件、JavaScript 运行环境、渲染引擎和页面等。

![单进程浏览器](/static/image/markdown/browser/single-process-browser.png)

单进程浏览器的缺点是显著的，它不稳定、不流畅、不安全。

由于早期的浏览器需要借助插件来实现 Web视频、Web 游戏等功能，而插件的质量良莠不齐，当插件崩溃时，便会导致整个浏览器的崩溃。另外，复杂的 JavaScript 代码经常会引起渲染引擎模块的崩溃，这也同样会导致整个浏览器发生崩溃。这便是不稳定的原因。

由于所有页面的功能模块都运行在同一个线程中（该进程的主线程），所以如果某个页面运行了耗时的脚本，便会导致整个浏览器陷入卡顿甚至假死的状态。另外，随着浏览器运行的时间越来越长，页面发生的内存泄漏（如果有）会累积的越来越多，这会导致浏览器占用的内存越来越高，浏览器也变得越来越慢。

## 多进程浏览器

2020 年的 Chrome 的进程架构如下所示，可见它包括：1 个浏览器主进程、1 个 GPU 进程、1 个网络进程、一至多个渲染进程和一至多个插件进程。事实上，Chrome 中还存在着更多的其它进程，比如扩展进程、代理进程、iframe进程，用于压缩、视频、音频等功能的进程。

- 浏览器进程：主要负责界面的显示、用户交互、管理子进程（其它进程都是它的子进程）、存储。
- 渲染进程：主要负责将 HTML、CSS、JavaScript 转换为网页，排版引擎 Blink 和 JavaScript 引擎（V8）都运行在该进程中。处于安全考虑，渲染进程运行在沙箱模式下。默认情况下，每个标签页面都拥有一个渲染进程。
- GPU 进程：负责绘制 Chrome 的 UI 界面以及网页的内容。
- 网络进程：负责页面的网络资源的加载。
- 插件进程：负责运行插件，每个插件都拥有一个插件进程。

![2020年的Chrome的进程架构](/static/image/markdown/browser/chrome-structure-2020.png)

这种多进程架构解决了上述的单进程架构的缺陷，比如：

- 页面或插件的崩溃或阻塞也只会影响到响应的渲染进程和插件进程，并不会影响到其他页面或整个浏览器
- 由于每个页面都运行在单独的渲染进程中，因此当页面关闭时，整个渲染进程也会被关闭，该进程所占的内存就会被完全回收，就可以解决内存泄漏的问题了
- 由于渲染进程和插件进程都运行在沙箱中，因此它们无法写入你的硬盘，也无法读取你的敏感数据，也无法获取系统权限。

## Chrome 的未来架构

2016 年，Chrome 官方团队宣布了未来的 Chrome 架构，这是一个基于 Serivices Oriented Architecture 思想的设计，这也是现代操作系统所采用的架构设计，这意味着 Chrome 的架构将会朝着现代操作系统的架构演化。

原来的各种模块会被重构成独立的服务（Service），每个服务都可以在独立的进程中运行，访问服务就必须使用定义好的接口，并使用 IPC 来通信，从而构建一个更内聚、松耦合、易于维护和扩展的系统，以更好的实现简单、稳定、高速、安全的目标。下图是 Chrome 的未来架构模型图：

![未来的Chrome的进程架构](/static/image/markdown/browser/chrome-structure-future.png)

目前 Chrome 还处于从旧架构向新架构过渡的阶段，这是一个漫长的迭代过程，因此你仍可以按照上文所述的内容来理解 Chrome 的架构。

