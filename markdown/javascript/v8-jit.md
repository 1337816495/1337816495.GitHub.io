# V8 引擎是如何执行 JavaScript 的

## 前置知识

CPU 只能执行二进制代码，我们把这些二进制代码称为机器指令，工程师们为 CPU 定义了许多有用的机器指令，我们把这些机器指令的集合称为指令集。

由于机器指令难以阅读和记忆，为了提升开发的效率，工程师们又将机器指令转换为易于阅读和记忆的汇编指令，我们把汇编指令的集合称为汇编指令集。

```
1000100111011000 // 机器指令
mov ax,bx        // 汇编指令
```

因为不同架构的 CPU 的指令集是不同的，所以不同架构的 CPU 的汇编指令集也是不同的，这导致了，如果我们想要用汇编指令集来编写一个通用的软件，那么我们就需要为不同架构的 CPU 编写不同的汇编代码。

> 比如 X86 和 ARM 是两种不同的 CPU 架构。

为了进一步提升开发效率，工程师们又发明了高级语言，比如 C、C++、Java 等，因为高级语言的引擎可以自动的将高级语言的代码编译成适配不同架构 CPU 和硬件的代码，所以当我们使用高级语言来开发时，就可以忽略 CPU 的架构了，同时还可以忽略其他硬件的知识，因为汇编指令集是要和硬件打交道的。

不过，CPU 无法执行汇编代码和高级语言的代码，所以无论是汇编代码，还是高级语言的代码，都需要被转译成机器代码后，才能被 CPU 执行。对于汇编代码而言，汇编代码需要经有汇编编译器处理后，才能转换为机器代码。对于高级语言的代码而言，主要有两种途径：

- 高级语言的代码经处理后，由解释器直接执行，然后输出结果。
- 高级语言的代码经处理后，由编译器编译为机器代码，然后由 CPU 执行，最后输出结果。

## V8 引擎

V8 是用于执行 JavaScript 的引擎，它被用在 Chromium 和 Node 中。V8 引擎在内部使用 JIT（just in time）编译器来执行 JavaScript 并输出结果。JIT 不仅仅是一个编译器，实际上，JIT 是编译器和解释器的混合体。V8 引擎执行 JavaScript 的大致流程如下：

- 首先，JavaScript 代码会被编译成 AST（abstract syntax tree，抽象语法树）。
- 然后解释器会将 AST 编译成字节码。
- 然后解释器会执行字节码，并输出结果。
- 如果某段字节码被解释器频繁执行的话，那么编译器就会将这段字节码编译成机器码，机器码的执行效率比字节码高的多，下次执行的时候，V8 引擎就会直接执行这段机器码。
- 如果某些数据发生了变化，那么这些数据所对应的机器码就会变成无效代码，这时 V8 引擎就会放弃这段机器码，回退到使用字节码。

无论是解释执行还是编译执行，V8 引擎都需要先将 JavaScript 代码编译成 AST 和字节码。不过 V8 引擎并不会在一开始就编译完所有的代码，而是只编译下述 3 种代码：

- 在即将执行全局代码之前，V8 引擎就会先编译完全局代码，但是不包括全局代码中的其他函数体内的代码，也不包括 `eval` 调用中的入参字符串。
- 在即将执行一个函数之前，V8 引擎就会先编译完函数体内的代码。
- 在即将执行一个 `eval` 调用之前，V8 引擎就会先编译完入参字符串。