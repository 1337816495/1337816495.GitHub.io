<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V8 引擎是如何执行 JavaScript 的</title>
</head>

<body>
    <header>
        <button><a href="/catalogue.html"><strong>CATALOGUE</strong></a></button>
    </header>
    <aside>
        <p>In this article</p>
        <p data-target-id=6938ac1b-fe7e-4d3e-bbd5-90ea40b92f4b>前置知识</p>
        <p data-target-id=3a2397c9-f377-4748-8d76-299d289ab08e>V8 引擎</p>
    </aside>
    <article>
        <h1>V8 引擎是如何执行 JavaScript 的</h1>
        <h2 id="6938ac1b-fe7e-4d3e-bbd5-90ea40b92f4b">前置知识</h2>
        <p>CPU 只能执行二进制代码，我们把这些二进制代码称为机器指令，工程师们为 CPU 定义了许多有用的机器指令，我们把这些机器指令的集合称为指令集。</p>
        <p>由于机器指令难以阅读和记忆，为了提升开发的效率，工程师们又将机器指令转换为易于阅读和记忆的汇编指令，我们把汇编指令的集合称为汇编指令集。</p>
        <pre><code>1000100111011000 // 机器指令
mov ax,bx        // 汇编指令
</code></pre>
        <p>因为不同架构的 CPU 的指令集是不同的，所以不同架构的 CPU 的汇编指令集也是不同的，这导致了，如果我们想要用汇编指令集来编写一个通用的软件，那么我们就需要为不同架构的 CPU 编写不同的汇编代码。</p>
        <blockquote>
            <p><strong>Note</strong></p>
            <p>比如 X86 和 ARM 是两种不同的 CPU 架构。</p>
        </blockquote>
        <p>为了进一步提升开发效率，工程师们又发明了高级语言，比如 C、C++、Java 等，因为高级语言的引擎可以自动的将高级语言的代码编译成适配不同架构 CPU 和硬件的代码，所以当我们使用高级语言来开发时，就可以忽略 CPU 的架构了，同时还可以忽略其他硬件的知识，因为汇编指令集是要和硬件打交道的。</p>
        <p>不过，CPU 无法执行汇编代码和高级语言的代码，所以无论是汇编代码，还是高级语言的代码，都需要被转译成机器代码后，才能被 CPU 执行。对于汇编代码而言，汇编代码需要经有汇编编译器处理后，才能转换为机器代码。对于高级语言的代码而言，主要有两种途径：</p>
        <ul>
            <li>高级语言的代码经处理后，由解释器直接执行，然后输出结果。</li>
            <li>高级语言的代码经处理后，由编译器编译为机器代码，然后由 CPU 执行，最后输出结果。</li>
        </ul>
        <h2 id="3a2397c9-f377-4748-8d76-299d289ab08e">V8 引擎</h2>
        <p>V8 是用于执行 JavaScript 的引擎，它被用在 Chromium 和 Node 中。</p>
        <p>V8 引擎在内部使用 JIT（just in time）编译器来执行 JavaScript 并输出结果，不过 JIT 不是一个纯粹的编译器，而是编译器和解释器的混合体。混合它们的目的是为了获得更快的冷启动速度与执行速度，因为解释器的特点是启动速度较快、执行速度较慢，而编译器的特点是启动速度较慢、执行速度较快。</p>
        <p>有趣的是，V8 官方分别为解释器和编译器取名为 Ignition 和 TurboFan，其中 Ignition 代表点火装置，TurboFan 代表涡轮增压。点火装置代表启动，涡轮增压代表加速，解释器和编译器在 V8 引擎中所发挥的作用正与它们的名字一致。</p>
        <p>最后，V8 引擎执行 JavaScript 代码的流程大致如下：</p>
        <ol>
            <li>将 JavaScript 代码编译成 AST</li>
            <li>解释器将 AST 编译成字节码</li>
            <li>解释器执行字节码并输出结果</li>
            <li>如果某段字节码被执行了多次，那么编译器就会将这段字节码编译成机器码，下次执行的时候就会直接使用这段机器码，机器码的执行效率比字节码高得多</li>
            <li>如果某些数据发生了变化，那么相应的机器码就会变成无效代码，V8 引擎会舍弃这段无效的机器码，并回退到使用字节码</li>
        </ol>
        <blockquote>
            <p><strong>Note</strong></p>
            <p>其中，AST 是指 Abstract Syntax Tree，即抽象语法树，它是转译和混淆代码的关键角色，你可以通过 <a href="https://astexplorer.net/">这个工具</a> 来体验一下 AST。</p>
        </blockquote>
        <p>无论是解释执行还是编译执行，V8 引擎都需要先将 JavaScript 代码编译成 AST 和字节码。不过 V8 引擎并不会在一开始就编译完所有的代码，而是只编译下述 3 种代码：</p>
        <ul>
            <li>在即将执行全局代码之前，V8 引擎就会先编译完全局代码，但是不包括全局代码中的其他函数体内的代码，也不包括 <code>eval</code> 调用中的入参字符串。</li>
            <li>在即将执行一个函数之前，V8 引擎就会先编译完函数体内的代码。</li>
            <li>在即将执行一个 <code>eval</code> 调用之前，V8 引擎就会先编译完入参字符串。</li>
        </ul>
    </article>
</body>

</html>